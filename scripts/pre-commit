#!/usr/bin/env bash
#
# Pre-commit hook: scan staged files for PII, credentials, and sensitive data.
# Prevents accidental commits of company names, real hostnames, personal info, etc.
#
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Patterns to block (case-insensitive)
# Each entry: "pattern|description"
BLOCKED_PATTERNS=(
  "globalhc|Company domain (globalhc)"
  "Global Healing|Company name"
  "GH-IT-|Company device prefix (GH-IT)"
  "GH-ADM-|Company device prefix (GH-ADM)"
  "GHC-|Company prefix (GHC)"
  "dwight\.banks|Personal username"
  "Dwight Banks|Personal name"
  "jss\.[a-z]+\.[a-z]+:[0-9]+|Jamf instance hostname with port"
  "@p!2040|Hardcoded password"
  "JAMF_CLIENT_SECRET=.[a-zA-Z0-9_-]{20}|Hardcoded Jamf client secret"
  "JAMF_CLIENT_ID=.[a-f0-9-]{36}|Hardcoded Jamf client ID"
)

# Only scan staged file contents (not binary files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACDMR | grep -E '\.(ts|js|json|md|mjs|sh|yml|yaml|txt|env)$')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND=0

for entry in "${BLOCKED_PATTERNS[@]}"; do
  pattern="${entry%%|*}"
  description="${entry##*|}"

  # Search staged content for the pattern
  matches=$(git diff --cached -U0 -- $STAGED_FILES | grep -iE "^\+" | grep -iE "$pattern" | head -5)

  if [ -n "$matches" ]; then
    if [ "$FOUND" -eq 0 ]; then
      echo ""
      echo -e "${RED}=== PII/CREDENTIAL CHECK FAILED ===${NC}"
      echo ""
    fi
    FOUND=1
    echo -e "${YELLOW}Blocked:${NC} $description"
    echo -e "  Pattern: $pattern"
    echo "$matches" | while read -r line; do
      echo -e "  ${RED}$line${NC}"
    done
    echo ""
  fi
done

if [ "$FOUND" -ne 0 ]; then
  echo -e "${RED}Commit blocked.${NC} Remove sensitive data before committing."
  echo "If this is a false positive, use: git commit --no-verify"
  echo ""
  exit 1
fi

exit 0
