# Ralph Progress Log
Started: 2025-01-07
Feature: High Priority Improvements & Missing Features

## Codebase Patterns
- TypeScript project with ES modules ("type": "module")
- Logger: Use createLogger() from src/server/logger.ts, NOT console.*
- Types: Define in src/types/, use Zod for validation
- Error handling: Use type guards, preserve stack traces
- Skills: Register in src/skills/index.ts
- Tools: Register in src/tools/index-compat.ts
- Tests: Jest with experimental VM modules, place in src/__tests__/
- Build: tsc compiles to dist/

## Error Handling Pattern
```typescript
} catch (error: unknown) {
  const message = error instanceof Error ? error.message : String(error);
  const stack = error instanceof Error ? error.stack : undefined;
  // Use message and stack
}
```

## Logger Usage Pattern
```typescript
import { createLogger } from './server/logger.js';
const logger = createLogger('ModuleName');
logger.info('message', { context });
logger.error('message', { error: message, stack });
```

## Key Files for Improvements
- src/server/logger.ts - Winston logger factory
- src/utils/type-guards.ts - Error type guards
- src/utils/retry.ts - Has CircuitBreaker class
- src/utils/error-handler.ts - Error handling patterns
- src/jamf-client-hybrid.ts - Main Jamf API client
- src/jamf-client-hybrid-fixed.ts - Duplicate client (to consolidate)
- src/server/health-check.ts - Health endpoint
- src/tools/tool-implementations.ts - Tool parameter validation needed

## Commands
- npm run typecheck - Type checking
- npm test - Run all tests
- npm run build:quick - Quick build
- npm run lint - ESLint

## Previous Session Learnings
- ESM mocking: jest.unstable_mockModule MUST be called before importing module
- Use `const { Class } = await import('./module.js')` after mocking
- Mock JamfApiClientHybrid with config.baseUrl and all API methods
- Use beforeEach/afterEach to reset process.argv and process.env
- Generated output directories should be in .gitignore
- Use conventional commit prefixes: feat, fix, docs, chore, test

---
## 2026-01-12 - IMP-001
- Removed all console.log/error/warn calls from src/
- Created CLI output utilities for proper CLI user output:
  - src/cli/output.ts - print(), printError(), printWarn()
  - src/agent/output.ts - same utilities for agent CLI
- Updated 21 source files to use logger or CLI output utilities
- **Learnings:**
  - CLI tools should use process.stdout.write/stderr.write wrappers, not console.*
  - Use `error: unknown` in catch blocks, then type guard with `error instanceof Error`
  - MCP servers must never output to stdout/stderr - it breaks JSON-RPC parsing
  - The SkillsManager tests have stale expectations - they reference non-existent skills

---
## 2026-01-12 - IMP-002
- Fixed all `catch (error: any)` patterns in src/ (28 occurrences)
- Changed to `catch (error: unknown)` with type guard pattern
- Files changed:
  - src/skills/http-initializer.ts
  - src/skills/manager.ts
  - src/skills/context-provider.ts
  - src/tools/skills-mcp-integration.ts (2 catch blocks)
  - src/tools/skills-integration.ts
  - src/tools/skills-tools.ts
  - src/skills/device-management/batch-inventory-update.ts (3 catch blocks)
  - src/skills/device-management/find-outdated-devices.ts
  - src/skills/device-management/device-search-optimized.ts (2 catch blocks)
  - src/skills/device-management/device-search.ts
  - src/skills/policy-management/deploy-policy-by-criteria.ts
  - src/skills/automation/scheduled-compliance-check.ts
  - src/tools/tool-implementations.ts
  - src/jamf-client-hybrid-fixed.ts
  - src/server/skills-endpoints.ts (4 catch blocks)
  - src/server/http-server.ts
  - src/agent/ai/providers/BedrockProvider.ts
  - src/agent/ai/providers/OpenAIProvider.ts
  - src/agent/core/TaskExecutor.ts (2 catch blocks)
  - src/agent/core/AgentCore.ts
- **Learnings:**
  - For AWS/Axios errors, cast to typed object to access properties like `.name` or `.response`
  - Example: `const errorName = (error as { name?: string }).name;`
  - When returning error in SkillResult, create Error object: `error instanceof Error ? error : new Error(message)`
  - Pre-existing test failures in SkillsManager tests are unrelated to error handling

---
